<?xml version="1.0" encoding="UTF-8"?>
<sequence name="com.wso2telco.dep.hub.smsmessagingapi.handle.outbound.requests.gather.Sequence" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <filter regex="Not Provisioned|Failed" source="$ctx:messageStatus">
        <then/>
        <else>
            <filter xpath="$body//deliveryInfo">
                <then>
                    <property name="messageStatus" scope="default" type="STRING" value="Created"/>
                    <property expression="json-eval($.outboundSMSMessageRequest.deliveryInfoList.resourceURL)" name="resourceURL" scope="default" type="STRING"/>
                    <property expression="json-eval($.outboundSMSMessageRequest.senderAddress)" name="senderAddress" scope="default" type="STRING"/>

                    <script language="js">
                        <![CDATA[
                                var payload= mc.getPayloadJSON();
                                var responseResourceUrl = payload.outboundSMSMessageRequest.resourceURL;
                                var operatorRequestId = responseResourceUrl.substring(responseResourceUrl.lastIndexOf('/') + 1);
                                if (!operatorRequestId) {
                                    throw 'ERROR - Unable extract operator request id (plugin_requestid) from response';
                                }
                                mc.setProperty('SEND_SMS_OPERATOR_REQUEST_ID', operatorRequestId);
                        ]]>
                    </script>
                    <foreach expression="//outboundSMSMessageRequest/address" xmlns:ns="http://org.apache.synapse/xsd">
                        <sequence>
                            <property expression="json-eval($.address)" name="address" scope="default" type="STRING" />
                            <property expression="fn:normalize-space($ctx:address)" group="1" name="address" pattern="((^(?!null).*$)|(^(null).+$))" scope="default" type="STRING" />
                            <dbreport>
                                <connection>
                                    <pool>
                                        <dsName>jdbc/WSO2TELCO_DEP_DB</dsName>
                                    </pool>
                                </connection>
                                <statement>
                                    <sql><![CDATA[insert into sendsms_reqid(hub_requestid, sender_address, delivery_address, plugin_requestid) values(?, ?, ?, ?);]]></sql>
                                    <parameter expression="$ctx:REQUEST_ID" type="VARCHAR"/>
                                    <parameter expression="$ctx:senderAddress" type="VARCHAR"/>
                                    <parameter expression="$ctx:address" type="VARCHAR"/>
                                    <parameter expression="$ctx:SEND_SMS_OPERATOR_REQUEST_ID" type="VARCHAR"/>
                                </statement>
                            </dbreport>
                        </sequence>
                    </foreach>
                </then>
                <else>
                    <property name="messageStatus" scope="default" type="STRING" value="Not Created"/>
                </else>
            </filter>
        </else>
    </filter>

    <property name="collection" scope="default">
        <subscription xmlns=""/>
    </property>
    <aggregate id="smsmessagingapi.outbound.requests.splitter">
        <completeCondition timeout="60">
            <messageCount max="-1" min="-1"/>
        </completeCondition>
        <onComplete enclosingElementProperty="collection" expression="//outboundSMSMessageRequest/deliveryInfoList/deliveryInfo">
            <!-- retrieve hub url from registry -->
            <property expression="$ctx:mediationConfig//huburl" name="HUB_URL" scope="default" type="STRING"/>
            <property expression="fn:concat($ctx:HUB_URL, $ctx:REST_FULL_REQUEST_PATH, '/', $ctx:notifyURLTableId)" name="responseResourceURL" scope="default" type="STRING"/>

            <!-- using script mediator to fetch original request and add deliveryInfo -->
            <script language="js">
                <![CDATA[
                        var requestJSONPayloadString = mc.getProperty('requestJSONPayload');
                        var requestJSONPayload = JSON.parse(requestJSONPayloadString);
                        requestJSONPayload.outboundSMSMessageRequest.deliveryInfoList = {};
                        requestJSONPayload.outboundSMSMessageRequest.deliveryInfoList.deliveryInfo = [];

                        var payload = mc.getPayloadXML();
                        var deliveryInfoList = payload..*::deliveryInfo;

                        for (var i=0; i<deliveryInfoList.length(); i++) {
                            requestJSONPayload.outboundSMSMessageRequest.deliveryInfoList.deliveryInfo[i] = {};
                            requestJSONPayload.outboundSMSMessageRequest.deliveryInfoList.deliveryInfo[i].address = deliveryInfoList[i]..*::address.toString();
                            requestJSONPayload.outboundSMSMessageRequest.deliveryInfoList.deliveryInfo[i].deliveryStatus = deliveryInfoList[i]..*::deliveryStatus.toString();
                        }

                        requestJSONPayload.outboundSMSMessageRequest.resourceURL = String(mc.getProperty('responseResourceURL'));

                        mc.setPayloadJSON(JSON.stringify(requestJSONPayload));
                ]]>
            </script>
            <!-- TODO: solve resourceURL in deliveryInfoList and main -->
            <sequence key="com.wso2telco.dep.common.main.response.Sequence"/>
        </onComplete>
    </aggregate>
</sequence>
