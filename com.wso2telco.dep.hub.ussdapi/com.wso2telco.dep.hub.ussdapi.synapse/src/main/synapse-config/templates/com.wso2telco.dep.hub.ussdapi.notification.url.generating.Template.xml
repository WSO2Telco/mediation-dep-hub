<?xml version="1.0" encoding="UTF-8"?>
<template name="com.wso2telco.dep.hub.ussdapi.notification.url.generating.Template" xmlns="http://ws.apache.org/ns/synapse">
    <parameter name="apiContext"/>
    <parameter name="notifyURL"/>
    <parameter name="apiResourceSuffix"/>
    <sequence>
        <filter xpath="boolean($func:notifyURL)">
            <then>
                <property expression="fn:normalize-space($func:apiContext)" group="1" name="hubAPIContext" pattern="((^(?!null).*$)|(^(null).+$))" scope="default" type="STRING"/>
                <property expression="$func:notifyURL" name="notifyURL" scope="default" type="STRING"/>
                <filter xpath="boolean($ctx:hubAPIContext)">
                    <then/>
                    <else>
                        <property expression="fn:normalize-space($ctx:CONTEXT)" group="1" name="hubAPIContext" pattern="((^(?!null).*$)|(^(null).+$))" scope="default" type="STRING"/>
                        <filter xpath="boolean($ctx:hubAPIContext)">
                            <then/>
                            <else>
                                <log category="ERROR" level="custom">
                                    <property name="ERROR" value="API Context cannot be empty"/>
                                </log>
                                <sequence key="com.wso2telco.dep.common.response.unexpectedError.Sequence"/>
                            </else>
                        </filter>
                    </else>
                </filter>
                <property expression="get-property('registry', 'conf:/repository/wso2telco/configurations/mediationConfig.xml')" name="mediationConfig" scope="default" type="OM"/>
                <property expression="$ctx:mediationConfig//huburl" name="hubURLPrefix" scope="default" type="STRING"/>
                <filter xpath="boolean($ctx:hubURLPrefix)">
                    <then/>
                    <else>
                        <log category="WARN" level="custom">
                            <property name="ERROR" value="Hub url cannot be empty"/>
                        </log>
                        <sequence key="com.wso2telco.dep.common.response.unexpectedError.Sequence"/>
                    </else>
                </filter>
                <filter xpath="boolean($func:apiResourceSuffix)">
                    <then>
                        <property expression="fn:concat('insert into ussd_request_entry (notifyurl,sp_consumerKey,operatorId,userId) values (&quot;',$ctx:notifyURL,'&quot;,&quot;',$ctx:CONSUMER_KEY,'&quot;,&quot;','null','&quot;,&quot;',$ctx:USER_ID,'&quot;)')" name="INSERT_QUERY" scope="default" type="STRING"/>
                        <sequence key="com.wso2telco.dep.common.execute.insert.query.Sequence"/>
                        <property expression="fn:concat($ctx:hubURLPrefix, $ctx:hubAPIContext, $func:apiResourceSuffix, '/', $ctx:GENERATED_ID)" name="NOTIFICATION_URL" scope="default" type="STRING"/>
                        <filter regex="true" source="get-property('INTERNAL_ERROR')">
                            <then>
                                <sequence key="com.wso2telco.dep.common.response.exceptions.Sequence"/>
                            </then>
                            <else/>
                        </filter>
                    </then>
                    <else>
                        <log category="WARN" level="custom">
                            <property name="ERROR" value="API resource path cannot be empty"/>
                        </log>
                        <sequence key="com.wso2telco.dep.common.response.unexpectedError.Sequence"/>
                    </else>
                </filter>
            </then>
            <else/>
        </filter>
    </sequence>
</template>
